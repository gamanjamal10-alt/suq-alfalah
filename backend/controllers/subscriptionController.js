const Subscription = require('../models/Subscription');
const Store = require('../models/Store');
exports.paySubscription = async (req,res)=>{ try{ const {paymentMethod}=req.body; if(!paymentMethod) return res.status(400).json({error:'طريقة الدفع مطلوبة'}); const store = await Store.findOne({owner:req.user._id}); if(!store) return res.status(404).json({message:'المتجر غير موجود'}); const subscription = await Subscription.findById(store.subscription); if(!subscription) return res.status(404).json({message:'الاشتراك غير موجود'}); const now=new Date(); const end = new Date(now); end.setFullYear(end.getFullYear()+1); subscription.paid=true; subscription.paymentMethod=paymentMethod; subscription.trial=false; subscription.startDate=now; subscription.endDate=end; await subscription.save(); store.active=true; await store.save(); res.json({message:'تم تفعيل الاشتراك', subscription}); }catch(err){res.status(500).json({error:err.message})}};
exports.checkSubscriptions = async ()=>{ try{ const expired = await Subscription.find({paid:true, endDate:{$lt:new Date()}}); for(const s of expired){ const store = await Store.findById(s.store); if(store){ store.active=false; await store.save(); } } }catch(err){console.error(err.message)} };
